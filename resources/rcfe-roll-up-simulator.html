<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RCFE PE Roll Up Simulator</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom styles for the slider thumb for a better look and feel */
        .slider::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 20px;
          height: 20px;
          background: white;
          border: 3px solid #3B82F6;
          border-radius: 50%;
          cursor: pointer;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
          transition: all 0.2s;
        }
        .slider::-webkit-slider-thumb:hover {
          transform: scale(1.1);
        }
        .slider::-moz-range-thumb {
          width: 20px;
          height: 20px;
          background: white;
          border: 3px solid #3B82F6;
          border-radius: 50%;
          cursor: pointer;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .group:hover .group-hover\:block {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen flex">
        <!-- Left Sidebar - Controls -->
        <div class="w-80 bg-white shadow-xl p-6 overflow-y-auto fixed h-full">
            <h1 class="text-2xl font-bold text-gray-900 mb-1">RCFE Roll Up Simulator</h1>
            <p class="text-sm text-gray-600 mb-6">Adjust parameters to model returns</p>
            
            <div id="controls-container">
                <!-- Sliders will be dynamically generated here -->
            </div>
        </div>

        <!-- Right Content Area - Dashboard -->
        <div class="ml-80 flex-1 p-6">
            <div class="grid grid-cols-10 gap-4 auto-rows-min">
                
                <!-- Row 1 - Key Metrics -->
                <div class="col-span-2 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-5 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-blue-100 text-xs">LP MOIC</p><p id="metric-moic" class="text-3xl font-bold">0.00x</p></div></div>
                </div>
                <div class="col-span-2 bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-5 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-green-100 text-xs">LP IRR</p><p id="metric-irr" class="text-3xl font-bold">0.0%</p></div></div>
                </div>
                <div class="col-span-2 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-5 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-purple-100 text-xs">LP Net Return</p><p id="metric-walkaway" class="text-3xl font-bold">$0.0M</p></div></div>
                </div>
                <div class="col-span-2 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl shadow-lg p-5 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-indigo-100 text-xs">GP Carried Interest</p><p id="metric-gp-carry" class="text-3xl font-bold">$0.0M</p></div></div>
                </div>
                <div class="col-span-2 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-5 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-orange-100 text-xs">Gross Exit Value</p><p id="metric-exitvalue" class="text-3xl font-bold">$0.0M</p></div></div>
                </div>

                <!-- Row 2 - Investment Summary & Exit Value -->
                <div class="col-span-5 bg-white rounded-xl shadow-lg p-5">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">Investment Summary</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Total Investment</p>
                            <p id="summary-investment" class="text-2xl font-bold text-gray-900">$0.0M</p>
                            <p id="summary-equity-debt" class="text-xs text-gray-500 mt-1">Equity: $0.0M | Debt: $0.0M</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Stabilized EBITDA</p>
                            <p id="summary-ebitda" class="text-2xl font-bold text-gray-900">$0.0M</p>
                            <p id="summary-revenue" class="text-xs text-gray-500 mt-1">on stabilized revenue of $0.0M</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t"><div class="flex justify-between"><span id="summary-re-appreciation-label" class="text-sm text-gray-600">RE Appreciation</span><span id="summary-re-appreciation-value" class="text-sm font-semibold text-green-600">+$0.0M</span></div></div>
                </div>
                <div class="col-span-5 bg-white rounded-xl shadow-lg p-5">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">Exit Value Composition</h3>
                    <div class="flex items-center justify-center h-full">
                        <div id="pie-chart-container" class="w-36 h-36 rounded-full flex items-center justify-center" style="background: conic-gradient(#3B82F6 0% 50%, #10B981 50% 100%);">
                             <div class="w-20 h-20 bg-white rounded-full"></div>
                        </div>
                        <div id="pie-chart-legend" class="ml-4 space-y-2"></div>
                    </div>
                </div>

                <!-- Row 3 - Charts & Ratings -->
                <div class="col-span-6 bg-white rounded-xl shadow-lg p-5">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">Revenue & EBITDA Projections</h3>
                    <div id="line-chart-container" class="w-full h-48"></div>
                </div>
                <div class="col-span-4 bg-white rounded-xl shadow-lg p-5">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">Performance Rating</h3>
                     <p id="rating-text" class="text-3xl font-bold text-gray-900">Moderate</p>
                     <p class="text-sm text-gray-600 mt-1">Target: 2.0x+ MOIC</p>
                     <div class="mt-3"><div class="w-full bg-gray-200 rounded-full h-2"><div id="rating-bar" class="h-2 rounded-full transition-all duration-500 bg-yellow-500" style="width: 50%"></div></div></div>
                </div>

                <!-- Row 4 - Sensitivity & Waterfall -->
                <div class="col-span-6 bg-white rounded-xl shadow-lg p-5">
                    <h3 id="sensitivity-title" class="text-lg font-bold text-gray-900 mb-3">IRR Sensitivity</h3>
                    <div id="sensitivity-chart-container" class="space-y-2"></div>
                </div>
                <div class="col-span-4 bg-white rounded-xl shadow-lg p-5">
                    <h3 class="text-lg font-bold text-gray-900 mb-3">Exit Waterfall</h3>
                    <div id="waterfall-container" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & CONFIGURATION ---
            const params = {
                monthlyRate: 10000,
                occupancyRate: 90,
                exitMultiple: 3.0,
                numUnits: 12,
                propertyAppreciation: 3.5,
                revenueGrowth: 4.0,
                expenseGrowth: 3.5,
                holdPeriod: 5,
                propertyValuePerUnit: 1600000,
                annualOpExPerUnit: 538857,
                debtRatio: 85,
                loanInterestRate: 8.0,
                loanTermYears: 20,
                exitTransactionCosts: 3.0,
                lpProfitSplit: 52,
                managementFee: 2.0
            };

            const sliderConfig = [
                { title: 'Deal Structure', key: 'numUnits', label: '# of Units', min: 1, max: 20, step: 1 },
                { key: 'propertyValuePerUnit', label: 'Property Value / Unit', min: 1000000, max: 2500000, step: 50000, prefix: '$' },
                { key: 'debtRatio', label: 'Loan-to-Value (LTV)', min: 60, max: 90, step: 1, unit: '%' },
                { key: 'loanInterestRate', label: 'Loan Interest Rate', min: 5, max: 10, step: 0.25, unit: '%' },
                { key: 'holdPeriod', label: 'Hold Period', min: 3, max: 10, step: 1, unit: ' yrs' },
                { title: 'Revenue Drivers', key: 'monthlyRate', label: 'Monthly Rate/Bed', min: 8000, max: 12000, step: 100, prefix: '$' },
                { key: 'occupancyRate', label: 'Occupancy Rate', min: 80, max: 98, step: 1, unit: '%' },
                { key: 'revenueGrowth', label: 'Annual Revenue Growth', min: 1, max: 6, step: 0.25, unit: '%' },
                { title: 'Expense & Exit', key: 'expenseGrowth', label: 'Annual Expense Growth', min: 1, max: 6, step: 0.25, unit: '%' },
                { key: 'exitMultiple', label: 'EBITDA Exit Multiple', min: 2, max: 8, step: 0.25, unit: 'x' },
                { key: 'propertyAppreciation', label: 'Annual RE Appreciation', min: 1, max: 6, step: 0.25, unit: '%' },
            ];

            const controlsContainer = document.getElementById('controls-container');

            // --- FINANCIAL CALCULATIONS ---
            function getCalculations(currentParams) {
                const {
                    monthlyRate, occupancyRate, exitMultiple, numUnits,
                    propertyAppreciation, revenueGrowth, expenseGrowth,
                    holdPeriod, propertyValuePerUnit, annualOpExPerUnit,
                    debtRatio, loanInterestRate, loanTermYears, exitTransactionCosts,
                    lpProfitSplit, managementFee
                } = currentParams;

                const totalPropertyValue = propertyValuePerUnit * numUnits;
                const totalDebt = totalPropertyValue * (debtRatio / 100);
                const totalEquityRequired = totalPropertyValue * (1 - (debtRatio / 100));
                const totalInvestorInflow = totalEquityRequired / (1 - (managementFee / 100));

                const bedsPerUnit = 6;
                const baseAnnualRevenue = bedsPerUnit * (occupancyRate / 100) * monthlyRate * 12 * numUnits;
                const stabilizedAnnualRevenue = baseAnnualRevenue * Math.pow(1 + revenueGrowth / 100, holdPeriod);
                const baseAnnualOpEx = annualOpExPerUnit * numUnits;
                const stabilizedAnnualOpEx = baseAnnualOpEx * Math.pow(1 + expenseGrowth / 100, holdPeriod);
                const stabilizedEbitda = stabilizedAnnualRevenue - stabilizedAnnualOpEx;

                const exitPropertyValue = totalPropertyValue * Math.pow(1 + propertyAppreciation / 100, holdPeriod);
                const exitBusinessValue = stabilizedEbitda * exitMultiple;
                const grossExitProceeds = exitPropertyValue + exitBusinessValue;

                const r = (loanInterestRate / 100) / 12;
                const n = loanTermYears * 12;
                const t = holdPeriod * 12;
                const loanBalanceAtExit = totalDebt > 0 ? totalDebt * (Math.pow(1 + r, n) - Math.pow(1 + r, t)) / (Math.pow(1 + r, n) - 1) : 0;

                const transactionCosts = grossExitProceeds * (exitTransactionCosts / 100);
                const netProceeds = grossExitProceeds - loanBalanceAtExit - transactionCosts;

                const totalProfit = netProceeds - totalInvestorInflow;
                const lpProfitShare = Math.max(0, totalProfit * (lpProfitSplit / 100));
                const gpCarriedInterest = Math.max(0, totalProfit * (1 - (lpProfitSplit / 100)));
                const lpTotalReturn = totalInvestorInflow + lpProfitShare;
                const lpMoic = totalInvestorInflow > 0 ? lpTotalReturn / totalInvestorInflow : 0;
                const lpIrr = totalInvestorInflow > 0 ? Math.pow(lpMoic, 1 / holdPeriod) - 1 : 0;

                return { stabilizedEbitda, stabilizedAnnualRevenue, totalInvestorInflow, totalDebt, exitPropertyValue, exitBusinessValue, grossExitProceeds, loanBalanceAtExit, transactionCosts, netProceeds, totalProfit, lpProfitShare, gpCarriedInterest, lpTotalReturn, lpMoic, lpIrr };
            }

            // --- RENDERING & DOM UPDATES ---
            function render() {
                const calcs = getCalculations(params);

                document.getElementById('metric-moic').innerText = `${calcs.lpMoic.toFixed(2)}x`;
                document.getElementById('metric-irr').innerText = `${(calcs.lpIrr * 100).toFixed(1)}%`;
                document.getElementById('metric-gp-carry').innerText = `$${(calcs.gpCarriedInterest / 1000000).toFixed(1)}M`;
                document.getElementById('metric-exitvalue').innerText = `$${(calcs.grossExitProceeds / 1000000).toFixed(1)}M`;
                document.getElementById('metric-walkaway').innerText = `$${(calcs.lpTotalReturn / 1000000).toFixed(1)}M`;

                document.getElementById('summary-investment').innerText = `$${(calcs.totalInvestorInflow / 1000000).toFixed(1)}M`;
                document.getElementById('summary-equity-debt').innerText = `Equity: ${((calcs.totalInvestorInflow - calcs.totalInvestorInflow * (params.managementFee/100)) / 1000000).toFixed(1)}M | Debt: ${(calcs.totalDebt / 1000000).toFixed(1)}M`;
                document.getElementById('summary-ebitda').innerText = `$${(calcs.stabilizedEbitda / 1000000).toFixed(1)}M`;
                document.getElementById('summary-revenue').innerText = `on stabilized revenue of $${(calcs.stabilizedAnnualRevenue / 1000000).toFixed(1)}M`;
                document.getElementById('summary-re-appreciation-label').innerText = `RE Appreciation (${params.propertyAppreciation}% × ${params.holdPeriod} yrs)`;
                document.getElementById('summary-re-appreciation-value').innerText = `+$${((calcs.exitPropertyValue - params.propertyValuePerUnit * params.numUnits) / 1000000).toFixed(1)}M`;

                renderPieChart(calcs.exitPropertyValue, calcs.exitBusinessValue);
                renderLineChart();
                renderRating(calcs.lpMoic);
                renderSensitivityChart();
                renderWaterfall(calcs);
            }
            
            function renderPieChart(reValue, bizValue) {
                const total = reValue + bizValue;
                const rePercent = total > 0 ? (reValue / total) * 100 : 50;
                
                document.getElementById('pie-chart-container').style.background = `conic-gradient(#3B82F6 0% ${rePercent}%, #10B981 ${rePercent}% 100%)`;
                document.getElementById('pie-chart-legend').innerHTML = `
                    <div class="flex items-center"><div class="w-3 h-3 rounded-full mr-2" style="background-color: #3B82F6;"></div><span class="text-sm text-gray-700">Real Estate: $${(reValue / 1000000).toFixed(1)}M</span></div>
                    <div class="flex items-center"><div class="w-3 h-3 rounded-full mr-2" style="background-color: #10B981;"></div><span class="text-sm text-gray-700">Business: $${(bizValue / 1000000).toFixed(1)}M</span></div>
                `;
            }

            function renderLineChart() {
                const yearlyData = [];
                for (let year = 1; year <= params.holdPeriod; year++) {
                    const revenue = (params.numUnits * 6 * (params.occupancyRate/100) * params.monthlyRate * 12) * Math.pow(1 + params.revenueGrowth / 100, year);
                    const expenses = (params.annualOpExPerUnit * params.numUnits) * Math.pow(1 + params.expenseGrowth / 100, year);
                    yearlyData.push({ year: `Y${year}`, revenue: revenue / 1000000, ebitda: (revenue - expenses) / 1000000 });
                }
                
                const container = document.getElementById('line-chart-container');
                const padding = 40;
                const width = container.clientWidth;
                const height = container.clientHeight;
                if (width === 0 || height === 0) return;
                
                const maxVal = Math.max(...yearlyData.map(d => d.revenue), 1);

                const toPath = (dataKey, color) => {
                    if (!yearlyData.length) return '';
                    let path = `M ${padding},${height - padding - (yearlyData[0][dataKey] / maxVal * (height - 2 * padding))}`;
                    yearlyData.forEach((d, i) => {
                        if (i === 0) return;
                        const x = padding + i * (width - 2 * padding) / (Math.max(1, yearlyData.length - 1));
                        const y = height - padding - (d[dataKey] / maxVal * (height - 2 * padding));
                        path += ` L ${x},${y}`;
                    });
                    return `<path d="${path}" stroke="${color}" stroke-width="3" fill="none" />`;
                };

                container.innerHTML = `<svg width="100%" height="100%"><line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#e5e7eb" /><line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#e5e7eb" /><text x="${padding - 10}" y="${padding}" text-anchor="end" alignment-baseline="middle" class="text-xs fill-current text-gray-500">${maxVal.toFixed(0)}M</text><text x="${padding - 10}" y="${height - padding}" text-anchor="end" alignment-baseline="middle" class="text-xs fill-current text-gray-500">0M</text>${toPath('revenue', '#3B82F6')}${toPath('ebitda', '#10B981')}${yearlyData.map((d, i) => `<text x="${padding + i * (width - 2 * padding) / (Math.max(1, yearlyData.length - 1))}" y="${height - padding + 20}" text-anchor="middle" class="text-xs fill-current text-gray-500">${d.year}</text>`).join('')}</svg>`;
            }
            
            function renderRating(moic) {
                const textEl = document.getElementById('rating-text');
                const barEl = document.getElementById('rating-bar');
                let ratingText, colorClass;
                if (moic >= 2.5) { ratingText = 'Exceptional'; colorClass = 'bg-green-500'; }
                else if (moic >= 2.0) { ratingText = 'Strong'; colorClass = 'bg-blue-500'; }
                else if (moic >= 1.5) { ratingText = 'Moderate'; colorClass = 'bg-yellow-500'; }
                else { ratingText = 'Below Target'; colorClass = 'bg-red-500'; }
                textEl.innerText = ratingText;
                barEl.className = `h-2 rounded-full transition-all duration-500 ${colorClass}`;
                barEl.style.width = `${Math.min(100, (moic / 3) * 100)}%`;
            }

            function renderSensitivityChart() {
                const baseCalcs = getCalculations(params);
                const baseIrr = baseCalcs.lpIrr * 100;
                
                const sensitivityConfig = [
                    { factor: 'Exit Multiple ±1x', paramName: 'exitMultiple', change: 1 },
                    { factor: 'Acq. Price ±$100k', paramName: 'propertyValuePerUnit', change: 100000 },
                    { factor: 'Interest Rate ±1%', paramName: 'loanInterestRate', change: 1 },
                    { factor: 'Occupancy ±5%', paramName: 'occupancyRate', change: 5 },
                    { factor: 'Revenue Growth ±1%', paramName: 'revenueGrowth', change: 1 },
                    { factor: 'Expense Growth ±1%', paramName: 'expenseGrowth', change: 1 },
                    { factor: 'Hold Period ±1yr', paramName: 'holdPeriod', change: 1 },
                ];

                const sensitivityData = sensitivityConfig.map(item => {
                    const upParams = { ...params, [item.paramName]: params[item.paramName] + item.change };
                    const downParams = { ...params, [item.paramName]: params[item.paramName] - item.change };
                    const upIrr = getCalculations(upParams).lpIrr * 100;
                    const downIrr = getCalculations(downParams).lpIrr * 100;
                    return { factor: item.factor, upside: upIrr - baseIrr, downside: downIrr - baseIrr };
                });

                const container = document.getElementById('sensitivity-chart-container');
                document.getElementById('sensitivity-title').innerText = `IRR Sensitivity (Base: ${baseIrr.toFixed(1)}%)`;
                const maxChange = Math.max(...sensitivityData.flatMap(d => [Math.abs(d.upside), Math.abs(d.downside)]), 1);
                
                container.innerHTML = sensitivityData.map(d => `<div class="flex items-center text-sm mb-1"><div class="w-32 text-right pr-2 text-gray-600">${d.factor}</div><div class="flex-1 flex items-center h-6 relative"><div class="w-1/2 h-full bg-gray-200 rounded-l-full flex justify-end items-center"><div class="bg-red-500 h-full rounded-l-full" style="width: ${Math.abs(d.downside) / maxChange * 100}%"></div></div><div class="w-1/2 h-full bg-gray-200 rounded-r-full flex justify-start items-center"><div class="bg-green-500 h-full rounded-r-full" style="width: ${Math.abs(d.upside) / maxChange * 100}%"></div></div><div class="absolute w-full text-center text-white font-bold text-xs pointer-events-none">${d.downside.toFixed(1)}% | ${d.upside.toFixed(1)}%</div></div></div>`).join('');
            }

            function renderWaterfall(calcs) {
                const container = document.getElementById('waterfall-container');
                const f = (val) => `$${(val / 1000000).toFixed(1)}M`;
                const gpSplit = 100 - params.lpProfitSplit;

                container.innerHTML = `
                    <div class="flex justify-between py-1"><span class="text-gray-600">Gross Exit Proceeds</span><span class="font-semibold">${f(calcs.grossExitProceeds)}</span></div>
                    <div class="flex justify-between py-1 text-red-600"><span>Less: Loan Payoff</span><span class="font-semibold">-${f(calcs.loanBalanceAtExit)}</span></div>
                    <div class="flex justify-between py-1 text-red-600"><span>Less: Transaction Costs</span><span class="font-semibold">-${f(calcs.transactionCosts)}</span></div>
                    <div class="flex justify-between py-1 border-t"><span class="text-gray-600">Net Proceeds</span><span class="font-semibold">${f(calcs.netProceeds)}</span></div>
                    <div class="flex justify-between py-1 text-red-600"><span>Less: Return of Capital</span><span>-${f(calcs.totalInvestorInflow)}</span></div>
                    <div class="flex justify-between py-2 border-t border-b font-semibold"><span>Total Profit</span><span>${f(calcs.totalProfit)}</span></div>
                    <div class="flex justify-between py-1"><span class="text-gray-600">GP Carry (${gpSplit}%)</span><span>${f(calcs.gpCarriedInterest)}</span></div>
                    <div class="flex justify-between py-1"><span class="text-gray-600">LP Profit Share (${params.lpProfitSplit}%)</span><span>${f(calcs.lpProfitShare)}</span></div>
                    <div class="flex justify-between py-2 border-t font-bold text-green-600"><span>LP Total Return</span><span>${f(calcs.lpTotalReturn)}</span></div>
                `;
            }

            // --- INITIALIZATION ---
            sliderConfig.forEach(config => {
                if (config.title) {
                    controlsContainer.appendChild(Object.assign(document.createElement('h3'), { className: 'text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 mt-6', innerText: config.title }));
                }
                const container = Object.assign(document.createElement('div'), { className: 'mb-5' });
                const valueId = `slider-value-${config.key}`;
                const sliderId = `slider-${config.key}`;
                container.innerHTML = `<div class="flex justify-between items-center mb-2"><label class="text-sm font-medium text-gray-700">${config.label}</label><span id="${valueId}" class="text-sm font-semibold text-gray-900"></span></div><input type="range" id="${sliderId}" min="${config.min}" max="${config.max}" step="${config.step}" value="${params[config.key]}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">`;
                controlsContainer.appendChild(container);

                const slider = document.getElementById(sliderId);
                const valueLabel = document.getElementById(valueId);

                const updateLabel = (val) => { valueLabel.innerText = `${config.prefix || ''}${parseFloat(val).toLocaleString()}${config.unit || ''}`; };
                const updateSliderBg = (val) => { const percent = (val - config.min) / (config.max - config.min) * 100; slider.style.background = `linear-gradient(to right, #3B82F6, #60A5FA ${percent}%, #E5E7EB ${percent}%)`; };

                slider.addEventListener('input', (e) => { updateLabel(e.target.value); updateSliderBg(e.target.value); });
                slider.addEventListener('change', (e) => { params[config.key] = parseFloat(e.target.value); render(); });
                
                updateLabel(params[config.key]);
                updateSliderBg(params[config.key]);
            });

            render();
        });
    </script>
</body>
</html>
